# Chapter11 高频考点汇总

## 窗口函数
窗口函数也叫OLAP函数（Online Anallytical Processing，联机分析处理）  
<窗口函数>的位置，可以放以下两种函数：  
专用窗口函数，包括后面要讲到的rank, dense_rank, row_number等专用窗口函数。  
聚合函数，如sum. avg, count, max, min等  
<img width="729" alt="image" src="https://user-images.githubusercontent.com/105503216/180232958-21adade3-4d25-4e03-ad91-31583b73e208.png">
<img width="718" alt="image" src="https://user-images.githubusercontent.com/105503216/180233037-e3eb6342-5274-4a67-a64c-0b5a38fdaf7c.png">

### 如果是空值 则输出null
<img width="643" alt="image" src="https://user-images.githubusercontent.com/105503216/192133816-efd22d62-7ede-48d1-8337-16badbbd83f0.png">  

注意，空表示表格没有任何输出，null表示输出为null！！！！  

1.只用一次select 错误!!!     

``` sql
select num
from my_numbers 
group by num
having count(num)=1
order by num desc
limit 0,1
```

这样出来的结果是空值  
<img width="172" alt="image" src="https://user-images.githubusercontent.com/105503216/192133926-467aa3e0-5a80-48d5-b847-0bd6d526cb19.png">  

2. 用两次select！推荐！
注意这个sub1不实在FROM后面的 而是在SELECT后面  

``` sql
SELECT(
	SELECT num
	FROM my_numbers 
	GROUP BY num
	HAVING COUNT(num)=1
	ORDER BY num DESC
	LIMIT 0,1
) sub1
```

3. 使用max/min/avg FROM 空值 输出的是NULL
<img width="396" alt="Screenshot 2022-09-25 at 4 01 47 PM" src="https://user-images.githubusercontent.com/105503216/192134063-be13c311-ca62-4f47-b4e9-4aeaa0c4e60f.png">  

``` sql
SELECT MAX(num) AS num
FROM
    (SELECT num 
    FROM MyNumbers
    GROUP BY num
    HAVING COUNT(*) = 1) sub1
```


## 列转换

EXERCISE1
<img width="886" alt="image" src="https://user-images.githubusercontent.com/105503216/180235702-6e94b4a0-9942-4ebb-a2f6-1ebfc98cb285.png">  
<img width="461" alt="image" src="https://user-images.githubusercontent.com/105503216/180237555-48256a73-ce75-45af-b267-7f8caf8e8f10.png">   

如果不分组 原数据有多少行 就有多少行  
按照人物分组 用sum/max选出那个唯一的非0分数  

EXERCISE2 
Students Report By Geography  
<img width="633" alt="image" src="https://user-images.githubusercontent.com/105503216/191899514-a28e470d-1cb7-4932-982c-e88f75556374.png">  

``` SQL
SELECT 
    MAX(CASE WHEN continent = 'America' THEN name END) AS America,
    MAX(CASE WHEN continent = 'Asia' THEN name END) AS Asia,
    MAX(CASE WHEN continent = 'Europe' THEN name END) AS Europe
FROM 
    (SELECT name, continent, ROW_NUMBER() OVER (PARTITION BY continent ORDER BY name) AS rk  # 如果没有这一步 直接case when 原数据有多少行就会有多少行
    FROM Student) sub1
GROUP BY rk
```

<img width="308" alt="image" src="https://user-images.githubusercontent.com/105503216/191900281-509b9ee4-b996-462f-abc1-a203e0a0277f.png">




## 求留存率
1. 求用户首次登陆后第二天依然登陆的比率  
思路：求出每个用户首次登陆的日期，和原来的表格（一定要是同一个用户一个日期在一行的表）合并；  
     判断是不是相差一天，是就是1，求和；  
     求所有unique的用户有几个，和上面的相除  
     
<img width="624" alt="image" src="https://user-images.githubusercontent.com/105503216/190852831-55e2e305-2040-4d08-a3b7-09e036850975.png">  
     
``` sql
SELECT 
    ROUND(SUM(CASE 
                WHEN DATEDIFF(a.event_date, sub1.first_log) = 1 THEN 1
                ELSE 0 END) / COUNT(DISTINCT a.player_id), 2) AS fraction
FROM 
    (SELECT player_id, MIN(event_date) AS first_log
    FROM Activity
    GROUP BY player_id) sub1
RIGHT JOIN Activity a
ON sub1.player_id = a.player_id
```

2. 求
